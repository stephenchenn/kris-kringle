<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wishlist</title>
  <link rel="icon" href="/favicon.ico">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; margin-bottom: 12px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; }
    input, textarea { width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 8px; }
    button { padding: 8px 12px; border-radius: 8px; border: 1px solid #d1d5db; background: #111; color:#fff; cursor:pointer; }
    .muted { color:#6b7280; font-size: 12px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 12px; }
    .item { border:1px solid #e5e7eb; border-radius: 12px; padding: 12px; }
    .bad { color:#b91c1c; }
    .ok { color:#065f46; }
  </style>
</head>
<body>
  <h1 id="title">My Wishlist</h1>
  <p class="muted">Tip: share this page URL with your group to let them see your wishlist. Your token identifies you—don’t share it outside your event.</p>

  <div class="card">
    <h3>Add item</h3>
    <div class="row">
      <input id="f_title" placeholder="Title *" />
      <input id="f_url" placeholder="Product link (optional)" />
      <input id="f_price" placeholder="Target price (e.g. 49.99)" />
      <textarea id="f_notes" rows="3" placeholder="Notes (size, color, etc.)"></textarea>
      <input id="f_image" placeholder="Image URL (optional)" />
    </div>
    <div class="row">
      <button id="btn_add">Add</button>
      <span id="msg" class="muted"></span>
    </div>
  </div>

  <h3>Items</h3>
  <div id="list" class="grid"></div>

  <script>
    const qs = new URLSearchParams(location.search);
    const token = qs.get('token');
    if (!token) {
      document.body.innerHTML = '<p class="bad">Missing token</p>';
      throw new Error('missing token');
    }

    async function load() {
      const r = await fetch(`/api/wishlist/me?token=${encodeURIComponent(token)}`);
      const data = await r.json();
      render(data.items||[]);
    }

    function el(tag, attrs={}, children=[]) {
      const n = document.createElement(tag);
      Object.entries(attrs).forEach(([k,v]) => (k==='class'? n.className=v : n.setAttribute(k,v)));
      children.forEach(c => n.append(c));
      return n;
    }

    function fmtPrice(cents) {
      if (cents==null || isNaN(cents)) return '';
      return `$${(cents/100).toFixed(2)}`;
    }

    async function onAdd() {
      const title = document.getElementById('f_title').value.trim();
      const url = document.getElementById('f_url').value.trim();
      const notes = document.getElementById('f_notes').value.trim();
      const price = document.getElementById('f_price').value.trim();
      const image_url = document.getElementById('f_image').value.trim();

      const price_cents = price ? Math.round(parseFloat(price)*100) : null;
      const resp = await fetch('/api/wishlist/item', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ token, title, url, notes, price_cents, image_url })
      });
      const out = await resp.json();
      const msg = document.getElementById('msg');
      if (!resp.ok) { msg.textContent = out.error || 'Error'; msg.className='bad'; return; }
      msg.textContent = 'Added!'; msg.className='ok';
      document.getElementById('f_title').value = '';
      document.getElementById('f_url').value = '';
      document.getElementById('f_price').value = '';
      document.getElementById('f_notes').value = '';
      document.getElementById('f_image').value = '';
      load();
    }

    function render(items) {
      const list = document.getElementById('list');
      list.innerHTML = '';
      items.forEach(it => {
        const card = el('div', { class:'item' });
        card.append(el('div', { class:'muted' }, [new Date(it.created_at).toLocaleString()]));
        const t = el('div', { style:'font-weight:600;margin:6px 0;' }, [it.title]);
        card.append(t);
        if (it.image_url) card.append(el('img', { src: it.image_url, alt: it.title, style:'max-width:100%;border-radius:10px;margin:4px 0;' }));
        if (it.url) card.append(el('a', { href: it.url, target:'_blank', rel:'noopener' }, ['View item']));
        if (it.notes) card.append(el('div', {}, [it.notes]));
        if (it.price_cents != null) card.append(el('div', { class:'muted' }, [fmtPrice(it.price_cents)]));

        const row = el('div', { class:'row' });
        const del = el('button', {}, ['Delete']);
        del.onclick = async () => {
          const r = await fetch(`/api/wishlist/item/${it.id}`, {
            method:'DELETE', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ token })
          });
          if (r.ok) load();
        };
        row.append(del);
        card.append(row);
        list.append(card);
      });
    }

    document.getElementById('btn_add').addEventListener('click', onAdd);
    load();
  </script>
</body>
</html>